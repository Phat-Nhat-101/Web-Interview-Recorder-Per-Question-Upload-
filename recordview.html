<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Record Details</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--brand:#004aad;--bg:#f5f5f5;--card:#ffffff}
    *{box-sizing:border-box}
    body{font-family:Arial,Segoe UI,Helvetica,Roboto,sans-serif;margin:0;background:var(--bg);color:#222}
    header{background:var(--brand);color:#fff;padding:18px 20px;text-align:center;font-size:20px;font-weight:600}
    main{max-width:980px;margin:18px auto;padding:14px}
    #detailBox{min-height:160px}
    .item{background:var(--card);border-left:6px solid var(--brand);padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
    .item h3{margin:0 0 8px 0;color:var(--brand);font-size:16px}
    .meta{font-size:13px;color:#444;margin:4px 0}
    pre.transcript{background:#eef6ff;padding:10px;border-radius:6px;white-space:pre-wrap;margin:8px 0;border:1px solid rgba(0,74,173,0.06)}
    button{background:var(--brand);color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .small{font-size:13px;color:#666}
    .error{color:#b00020;font-weight:600}
    video{width:100%;max-width:720px;border-radius:8px;margin-top:8px}
    .back{background:#e6eefc;color:var(--brand);padding:8px 12px;border-radius:6px;border:1px solid rgba(0,74,173,0.08);cursor:pointer}
  </style>
</head>
<body>
  <header>Record Details</header>
  <main>
    <div class="controls">
      <button id="backBtn" class="back" title="Back to records list">← Back</button>
      <div class="small" id="sessionInfo">Loading session...</div>
    </div>

    <div id="detailBox">Loading...</div>
  </main>

<script>
/*
  Single-file record view.
  Usage:
    /recordview.html?meetingId=123&folder=2025..._MID123_USER_Name
*/

(async function(){
  const params = new URLSearchParams(window.location.search);
  const meetingId = params.get("meetingId") || params.get("id");
  const folder = params.get("folder");
  const detailBox = document.getElementById("detailBox");
  const sessionInfo = document.getElementById("sessionInfo");
  const backBtn = document.getElementById("backBtn");

  // Back button: go back to interviewrecord page (preserve meetingId)
  backBtn.onclick = () => {
    if (meetingId) {
      window.location.href = `interviewrecord.html?meetingId=${encodeURIComponent(meetingId)}`;
    } else {
      window.history.back();
    }
  };

  // Basic checks
  if (!folder) {
    detailBox.innerHTML = `<p class="error">No folder selected.</p>
      <p class="small">Go back to Records list and choose a session.</p>`;
    sessionInfo.textContent = "No folder";
    return;
  }
  if (!meetingId) {
    detailBox.innerHTML = `<p class="error">Missing meetingId.</p>`;
    sessionInfo.textContent = `Folder: ${folder}`;
    return;
  }

  sessionInfo.textContent = `Meeting: ${meetingId} · Folder: ${folder}`;

  // Fetch record detail from server
  try {
    const resp = await fetch(`/api/records/${encodeURIComponent(meetingId)}/${encodeURIComponent(folder)}`);
    if (!resp.ok) throw new Error(`Network error: ${resp.status}`);
    const data = await resp.json();
    console.log("Record API response:", data);

    if (!data.ok) {
      detailBox.innerHTML = `<p class="error">Record not found or server returned error.</p>
        <p class="small">Message: ${data.error ? escapeHtml(data.error) : 'N/A'}</p>`;
      return;
    }

    if (!Array.isArray(data.data) || data.data.length === 0) {
      detailBox.innerHTML = `<p class="small">No details found in this record!</p>`;
      return;
    }

    // Sort by questionIndex numeric
    const sorted = [...data.data].sort((a,b) => Number(a.questionIndex) - Number(b.questionIndex));
    detailBox.innerHTML = "";
    sorted.forEach(item => {
      const idx = item.questionIndex ?? "?";
      const uploadedAt = item.uploadedAt ?? "Unknown";
      const transcript = item.transcript ?? "";
      const videoFile = item.video ?? item.videoFile ?? null;

      const div = document.createElement("div");
      div.className = "item";

      div.innerHTML = `
        <h3>Question ${escapeHtml(String(idx))}</h3>
        <div class="meta"><strong>Uploaded:</strong> ${escapeHtml(String(uploadedAt))}</div>
        <div class="meta"><strong>Transcript:</strong></div>
        <pre class="transcript">${escapeHtml(transcript) || "(No transcript)"}</pre>
      `;

      if (videoFile) {
        const videoWrapper = document.createElement("div");
        const videoEl = document.createElement("video");
        videoEl.controls = true;
        // construct url to static uploads
        videoEl.src = `/uploads/${encodeURIComponent(folder)}/${encodeURIComponent(videoFile)}`;
        videoWrapper.appendChild(videoEl);

        const openBtn = document.createElement("button");
        openBtn.textContent = "Open video in new tab";
        openBtn.onclick = () => window.open(videoEl.src, "_blank");
        videoWrapper.appendChild(openBtn);

        div.appendChild(videoWrapper);
      } else {
        const noVid = document.createElement("div");
        noVid.className = "small";
        noVid.textContent = "No video file found for this question.";
        div.appendChild(noVid);
      }

      detailBox.appendChild(div);
    });

  } catch (err) {
    console.error(err);
    detailBox.innerHTML = `<p class="error">Error loading record.</p>
      <p class="small">${escapeHtml(err.message || String(err))}</p>`;
  }

  // small helper to escape text
  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }
})();
</script>
</body>
</html>

